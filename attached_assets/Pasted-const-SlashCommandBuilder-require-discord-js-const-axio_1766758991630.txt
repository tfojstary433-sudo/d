const { SlashCommandBuilder } = require("discord.js");
const axios = require("axios");

const API_URL =
  "https://2cc8fdff-58f5-4de4-ba18-23c3c389e63d-00-10zd3s5b89sgn.janeway.replit.dev/api/match/lineup";

async function fetchRobloxIds(usernames) {
  const res = await axios.post(
    "https://users.roblox.com/v1/usernames/users",
    {
      usernames,
      excludeBannedUsers: true
    }
  );

  const map = {};
  for (const u of res.data.data) {
    map[u.name.toLowerCase()] = u.id;
  }
  return map;
}

module.exports = {
  data: new SlashCommandBuilder()
    .setName("sklad")
    .setDescription("Ustaw skÅ‚ad druÅ¼yny (nicki Roblox)")
    .addStringOption(o =>
      o.setName("uuid").setDescription("UUID meczu").setRequired(true)
    )
    .addStringOption(o =>
      o.setName("druzyna")
        .setDescription("DruÅ¼yna")
        .setRequired(true)
        .addChoices(
          { name: "Gospodarze (A)", value: "A" },
          { name: "GoÅ›cie (B)", value: "B" }
        )
    )
    .addStringOption(o =>
      o.setName("zawodnicy")
        .setDescription("Format: Nick, Nick | NickRezerwa")
        .setRequired(true)
    )
    .addStringOption(o =>
      o.setName("formacja")
        .setDescription("Np. 4-4-2")
        .setRequired(false)
    ),

  async execute(interaction) {
    await interaction.deferReply({ ephemeral: true });

    const uuid = interaction.options.getString("uuid");
    const team = interaction.options.getString("druzyna");
    const formation = interaction.options.getString("formacja") || "4-4-2";
    const raw = interaction.options.getString("zawodnicy");

    const [startersRaw, benchRaw] = raw.split("|");

    const startersNames = startersRaw
      .split(",")
      .map(n => n.trim())
      .filter(Boolean);

    const benchNames = benchRaw
      ? benchRaw.split(",").map(n => n.trim()).filter(Boolean)
      : [];

    const allNames = [...startersNames, ...benchNames];

    try {
      // ğŸ”¥ POBIERAMY ROBLOX ID
      const idMap = await fetchRobloxIds(allNames);

      const makePlayers = (names) =>
        names.map(name => {
          const id = idMap[name.toLowerCase()];
          if (!id) throw new Error(`Nie znaleziono gracza Roblox: ${name}`);
          return { name, id };
        });

      const starters = makePlayers(startersNames);
      const bench = makePlayers(benchNames);

      await axios.post(API_URL, {
        uuid,
        team,
        formation,
        starters,
        bench
      });

      await interaction.editReply(
        `âœ… SkÅ‚ad zapisany!\n` +
        `ğŸ‘¥ DruÅ¼yna: ${team}\n` +
        `âš½ Podstawa: ${starters.length}\n` +
        `ğŸª‘ Rezerwa: ${bench.length}\n` +
        `ğŸ“‹ Formacja: ${formation}`
      );
    } catch (err) {
      console.error(err);
      await interaction.editReply(
        `âŒ BÅ‚Ä…d: ${err.message}`
      );
    }
  }
};
